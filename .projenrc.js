const { javascript, TextFile } = require('projen');

const config = {
  name: "test",
  awsRegion: "us-east-1",
  awsAccountId: "123456789012", // À configurer
  ecrRepositoryName: "my-app", // À configurer
  nodeVersion: "20",
  port: 3000
};

const project = new javascript.NodeProject({
  name: `${config.name}`,
  description: `${config.description || "Generated by Modularite"}`,
  defaultReleaseBranch: `main`,
  authorName: `${config.authorName || "Modularite"}`,
  authorEmail: `${config.authorEmail || "bot@modularite.local"}`,
  packageManager: javascript.NodePackageManager.NPM,
  minNodeVersion: config.nodeVersion,
  
  // Désactiver tous les workflows par défaut
  release: false,
  releaseToNpm: false,
  buildWorkflow: false,
  depsUpgrade: false,
  pullRequestTemplate: false,

  // Activer github
  github: true,

  scripts: {
    'start': 'node lib/index.js',
    'docker:build': `docker build -t ${config.name}:latest .`,
    'docker:run': `docker run -p ${config.port}:${config.port} ${config.name}:latest`,
  },
});

// Dockerfile
const dockerfile = `# Build stage
FROM node:${config.nodeVersion}-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build --if-present

# Production stage
FROM node:${config.nodeVersion}-alpine

WORKDIR /app

# Créer utilisateur non-root
RUN addgroup -g 1001 -S nodejs && \\
    adduser -S nodejs -u 1001

# Copier les fichiers
COPY --from=builder --chown=nodejs:nodejs /app/package*.json ./
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/lib ./lib

RUN npm ci --only=production && npm cache clean --force

USER nodejs

EXPOSE ${config.port}

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\
  CMD node -e "require('http').get('http://localhost:${config.port}/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

CMD ["npm", "start"]
`;

new TextFile(project, 'Dockerfile', {
  lines: dockerfile.split('\n'),
  committed: true,
  readonly: false,
});

// .dockerignore
const dockerignore = `node_modules
npm-debug.log
.git
.gitignore
.github
.vscode
.idea
coverage
test
*.test.js
*.spec.js
.env
.DS_Store
.projen
.projenrc.js
dist
*.md
!README.md
`;

new TextFile(project, '.dockerignore', {
  lines: dockerignore.split('\n'),
  committed: true,
  readonly: false,
});

// GitHub Actions workflow - UNIQUEMENT build-push
if (project.github) {
  project.github?.addWorkflow('build-push', {
    name: `Build and Push Docker Image`,
    on: {
      push: {
        branches: ['main', 'develop'],
      },
      workflow_dispatch: {},
    },
    jobs: {
      build: {
        'runs-on': `ubuntu-latest`,
        permissions: {
          contents: 'read',
          'id-token': 'write',
        },
        steps: [
          {
            name: `Checkout`,
            uses: `actions/checkout@v4`,
          },
          {
            name: `Set up Docker Buildx`,
            uses: `docker/setup-buildx-action@v3`,
          },
          {
            name: `Configure AWS credentials`,
            uses: `aws-actions/configure-aws-credentials@v4`,
            with: {
              'role-to-assume': `arn:aws:iam::${config.awsAccountId}:role/GitHubActionsRole`,
              'aws-region': config.awsRegion,
            },
          },
          {
            name: `Login to Amazon ECR`,
            id: `login-ecr`,
            uses: `aws-actions/amazon-ecr-login@v2`,
          },
          {
            name: `Build and push Docker image`,
            uses: `docker/build-push-action@v5`,
            with: {
              context: '.',
              push: true,
              tags: `\${{ steps.login-ecr.outputs.registry }}/${config.ecrRepositoryName}:\${{ github.sha }},\${{ steps.login-ecr.outputs.registry }}/${config.ecrRepositoryName}:latest`,
              'cache-from': ['type=gha'],
              'cache-to': ['type=gha,mode=max'],
            },
          },
          {
            name: `Image info`,
            run: `echo "✅ Image pushed: \${{ steps.login-ecr.outputs.registry }}/${config.ecrRepositoryName}:\${{ github.sha }}"`,
          },
        ],
      },
    },
  });
}

project.synth();