const { javascript, TextFile } = require('projen');

const config = {
  name: "test",
  awsRegion: "eu-west-3",
  ecrRepositoryName: "modularite", // À configurer
  nodeVersion: "20",
  port: 3000
};

const project = new javascript.NodeProject({
  name: config.name,
  description: "Generated by Modularite",
  defaultReleaseBranch: 'main',
  authorName: "Modularite",
  authorEmail: "bot@modularite.local",
  packageManager: javascript.NodePackageManager.NPM,
  minNodeVersion: config.nodeVersion,
  github: true,
  githubOptions: { 
    pullRequestLint: false,
    pullRequestTemplate: false
  },
  release: false,
  releaseToNpm: false,
  buildWorkflow: false,
  depsUpgrade: false,
});

// ✅ Tasks Docker
project.addTask('docker:build', {
  exec: `docker build -t ${config.name}:latest .`
});

project.addTask('docker:run', {
  exec: `docker run -p ${config.port}:${config.port} ${config.name}:latest`
});

// ✅ Dockerfile
const dockerfile = `# Build stage
FROM node:${config.nodeVersion}-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build --if-present

# Production stage
FROM node:${config.nodeVersion}-alpine
WORKDIR /app
RUN addgroup -g 1001 -S nodejs && adduser -S nodejs -u 1001
COPY --from=builder --chown=nodejs:nodejs /app/package*.json ./
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/lib ./lib
RUN npm ci --only=production && npm cache clean --force
USER nodejs
EXPOSE ${config.port}
CMD ["npm", "start"]
`;

new TextFile(project, 'Dockerfile', {
  lines: dockerfile.split('\n'),
  committed: true,
  readonly: false,
});

// ✅ .dockerignore
const dockerignore = `node_modules
npm-debug.log
.git
.gitignore
.github
.vscode
.idea
coverage
test
*.test.js
*.spec.js
.env
.DS_Store
.projen
.projenrc.js
dist
*.md
!README.md
`;

new TextFile(project, '.dockerignore', {
  lines: dockerignore.split('\n'),
  committed: true,
  readonly: false,
});

// ✅ Workflow GitHub Actions (version Projen native)
const wf = project.github.addWorkflow('build-push');
wf.on({
  push: { branches: ['main', 'develop'] },
  workflowDispatch: {},
});

wf.addJob('build', {
  runsOn: ['ubuntu-latest'],
  permissions: {
    contents: 'read',
    idToken: 'write',
  },
  steps: [
    { name: 'Checkout', uses: 'actions/checkout@v4' },
    { 
      name: 'Configure AWS credentials',
      uses: 'aws-actions/configure-aws-credentials@v4',
      with: {
        'role-to-assume': '${{ secrets.AWS_ROLE_ARN_TO_ASSUME_FOR_ECR_MODULARITE }}',
        'aws-region': config.awsRegion,
       // 'role-session-name': 'GHActionSession' in directus9 for email checkin
      },
    },
    { name: 'Login to Amazon ECR', id: 'login-ecr', uses: 'aws-actions/amazon-ecr-login@v2' },
    { 
      name: 'Build and push Docker image',
      uses: 'docker/build-push-action@v5',
      with: {
        context: '.',
        push: true,
        tags: `\${{ steps.login-ecr.outputs.registry }}/${config.ecrRepositoryName}:\${{ github.sha }},\${{ steps.login-ecr.outputs.registry }}/${config.ecrRepositoryName}:latest`,
      },
    },
    { name: 'Image info', run: `echo "✅ Image pushed: \${{ steps.login-ecr.outputs.registry }}/${config.ecrRepositoryName}:\${{ github.sha }}"` },
  ],
});

project.synth();
