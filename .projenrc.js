const { javascript } = require('projen');

const config = {
  name: "test",
  awsRegion: "eu-west-3",
  awsAccountId: "123456789012", // À configurer
  ecrRepositoryName: "my-app" // À configurer
};

const project = new javascript.NodeProject({
  name: `${config.name}`,
  description: `${config.description || "Generated by Modularite"}`,
  defaultReleaseBranch: `main`,
  authorName: `${config.authorName || "Modularite"}`,
  authorEmail: `${config.authorEmail || "bot@modularite.local"}`,
  packageManager: javascript.NodePackageManager.NPM,
});

// Add GitHub Actions workflow for Docker build and push
project.github?.addWorkflow('build-push', {
  name: `Build and Push Docker Image`,
  on: {
    push: {
      branches: ['main', 'develop'],
    },
    workflow_dispatch: {},
  },
  jobs: {
    build: {
      'runs-on': `ubuntu-latest`,
      permissions: {
        contents: 'read',
        'id-token': 'write', // Pour OIDC
      },
      steps: [
        {
          name: `Checkout`,
          uses: `actions/checkout@v4`,
        },
        {
          name: `Configure AWS credentials via OIDC`,
          uses: `aws-actions/configure-aws-credentials@v4`,
          with: {
            'role-to-assume': `arn:aws:iam::${config.awsAccountId}:role/GitHubActionsRole`,
            'aws-region': config.awsRegion,
            'role-session-name': 'GitHubActions-Docker-Build',
          },
        },
        {
          name: `Login to Amazon ECR`,
          id: `login-ecr`,
          uses: `aws-actions/amazon-ecr-login@v2`,
        },
        {
          name: `Set up Docker Buildx`,
          uses: `docker/setup-buildx-action@v3`,
        },
        {
          name: `Build Docker image`,
          env: {
            ECR_REGISTRY: `\${{ steps.login-ecr.outputs.registry }}`,
            ECR_REPOSITORY: config.ecrRepositoryName,
            IMAGE_TAG: `\${{ github.sha }}`,
          },
          run: `
            docker buildx build \\
              --platform linux/amd64 \\
              --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \\
              --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \\
              --load \\
              .
          `,
        },
        {
          name: `Scan image for vulnerabilities`,
          uses: `aquasecurity/trivy-action@master`,
          with: {
            'image-ref': `\${{ steps.login-ecr.outputs.registry }}/${config.ecrRepositoryName}:\${{ github.sha }}`,
            format: 'sarif',
            output: 'trivy-results.sarif',
            severity: 'CRITICAL,HIGH',
            'exit-code': '1', // Fail si vulnérabilités critiques
          },
        },
        {
          name: `Push image to Amazon ECR`,
          env: {
            ECR_REGISTRY: `\${{ steps.login-ecr.outputs.registry }}`,
            ECR_REPOSITORY: config.ecrRepositoryName,
            IMAGE_TAG: `\${{ github.sha }}`,
          },
          run: `
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          `,
        },
      ],
    },
  },
});

project.synth();